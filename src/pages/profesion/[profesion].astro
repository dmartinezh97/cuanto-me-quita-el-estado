---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Footer from '../../components/astro/Footer.astro';
import CookieBanner from '../../components/astro/CookieBanner.astro';
import FiscalCalculator from '../../components/vue/calculator/FiscalCalculator.vue';
import { getCommunityById } from '@fiscal/constants';
import professionsData from '../../data/professions.json';
import salariesData from '../../data/salaries.json';

interface TopCCAA {
  id: string;
  salary: number;
  notes: string;
}

interface Profession {
  slug: string;
  name: string;
  description: string;
  category: string;
  metaTitle: string;
  metaDescription: string;
  avgMonthly: number;
  avgAnnual: number;
  range: { min: number; max: number };
  topCCAA: TopCCAA[];
  deductions: string[];
  demand: string;
  growth: string;
  notes?: string;
  relatedProfessions: string[];
}

export function getStaticPaths() {
  return professionsData.professions.map((profession: Profession) => ({
    params: { profesion: profession.slug },
    props: { profession },
  }));
}

const { profession } = Astro.props as { profession: Profession };

const title = profession.metaTitle;
const description = profession.metaDescription;

const formatCurrency = (amount: number) => `€${amount.toLocaleString('es-ES')}`;

const demandLabels: Record<string, { text: string; color: string }> = {
  'very-high': { text: 'Muy alta', color: 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400' },
  'high': { text: 'Alta', color: 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400' },
  'medium': { text: 'Media', color: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400' },
  'low': { text: 'Baja', color: 'bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-400' },
  'variable': { text: 'Variable', color: 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400' },
};

const growthLabels: Record<string, { text: string; color: string }> = {
  'very-high': { text: 'Muy alto', color: 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400' },
  'high': { text: 'Alto', color: 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400' },
  'medium': { text: 'Medio', color: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400' },
  'low': { text: 'Bajo', color: 'bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-400' },
};

// Schema.org
const schemaOrg = {
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": title,
  "description": description,
  "url": `${Astro.site}profesion/${profession.slug}`,
  "inLanguage": "es-ES",
  "mainEntity": {
    "@type": "Occupation",
    "name": profession.name,
    "description": profession.description,
    "estimatedSalary": {
      "@type": "MonetaryAmountDistribution",
      "name": "Salario base en España",
      "currency": "EUR",
      "duration": "P1M",
      "median": profession.avgMonthly,
      "percentile10": profession.range.min,
      "percentile90": profession.range.max
    },
    "occupationLocation": {
      "@type": "Country",
      "name": "España"
    }
  }
};

// Get related professions data
const relatedProfessions = profession.relatedProfessions
  .map(slug => professionsData.professions.find((p: Profession) => p.slug === slug))
  .filter(Boolean)
  .slice(0, 3) as Profession[];
---

<BaseLayout {title} {description}>
  <script type="application/ld+json" set:html={JSON.stringify(schemaOrg)} />

  <div class="flex flex-col min-h-screen">
    <!-- Hero Section -->
    <section class="bg-gradient-to-b from-surface to-surface-secondary border-b border-border">
      <div class="container mx-auto px-4 py-12 max-w-5xl">
        <!-- Breadcrumbs -->
        <nav class="mb-6 text-sm" aria-label="Breadcrumb">
          <ol class="flex items-center space-x-2 text-text-secondary">
            <li><a href="/" class="hover:text-text-primary transition-colors">Inicio</a></li>
            <li><span class="mx-2">/</span></li>
            <li><span>Profesiones</span></li>
            <li><span class="mx-2">/</span></li>
            <li class="text-text-primary" aria-current="page">{profession.name}</li>
          </ol>
        </nav>

        <!-- Main heading -->
        <h1 class="font-display text-4xl md:text-5xl font-semibold text-text-primary mb-4">
          Sueldo de {profession.name} en España
        </h1>

        <p class="text-lg text-text-secondary mb-8 max-w-3xl">
          {profession.description}. Descubre cuánto gana un/a {profession.name.toLowerCase()} según comunidad autónoma y calcula tu salario neto real.
        </p>

        <!-- Key stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
          <div class="bg-surface border border-border rounded-lg p-4">
            <div class="text-sm text-text-secondary mb-1">Salario medio</div>
            <div class="font-display text-2xl font-semibold text-text-primary">
              {formatCurrency(profession.avgMonthly)}
            </div>
            <div class="text-xs text-text-tertiary">/mes bruto</div>
          </div>

          <div class="bg-surface border border-border rounded-lg p-4">
            <div class="text-sm text-text-secondary mb-1">Rango salarial</div>
            <div class="font-display text-2xl font-semibold text-text-primary">
              {formatCurrency(profession.range.min)} - {formatCurrency(profession.range.max)}
            </div>
            <div class="text-xs text-text-tertiary">/mes bruto</div>
          </div>

          <div class="bg-surface border border-border rounded-lg p-4">
            <div class="text-sm text-text-secondary mb-1">Demanda laboral</div>
            <span class={`inline-block px-2 py-1 rounded text-sm font-medium ${demandLabels[profession.demand]?.color || demandLabels.medium.color}`}>
              {demandLabels[profession.demand]?.text || profession.demand}
            </span>
          </div>

          <div class="bg-surface border border-border rounded-lg p-4">
            <div class="text-sm text-text-secondary mb-1">Crecimiento</div>
            <span class={`inline-block px-2 py-1 rounded text-sm font-medium ${growthLabels[profession.growth]?.color || growthLabels.medium.color}`}>
              {growthLabels[profession.growth]?.text || profession.growth}
            </span>
          </div>
        </div>
      </div>
    </section>

    <!-- Salary by CCAA Section -->
    <section class="py-12 bg-surface-secondary">
      <div class="container mx-auto px-4 max-w-5xl">
        <h2 class="font-display text-2xl font-semibold text-text-primary mb-6">
          Salario de {profession.name} por comunidad autónoma
        </h2>

        <div class="bg-surface border border-border rounded-xl overflow-hidden">
          <table class="w-full">
            <thead class="bg-surface-secondary border-b border-border">
              <tr>
                <th class="px-6 py-4 text-left text-sm font-semibold text-text-primary">Comunidad Autónoma</th>
                <th class="px-6 py-4 text-center text-sm font-semibold text-text-primary">Salario Medio</th>
                <th class="px-6 py-4 text-left text-sm font-semibold text-text-primary hidden md:table-cell">Notas</th>
                <th class="px-6 py-4 text-center text-sm font-semibold text-text-primary">Acción</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-border">
              {profession.topCCAA.map((ccaa, index) => {
                const community = getCommunityById(ccaa.id) || getCommunityById(ccaa.id.replace(/-/g, '_'));
                const ccaaSlug = ccaa.id.replace(/_/g, '-');
                const vsAvg = ((ccaa.salary - profession.avgMonthly) / profession.avgMonthly * 100).toFixed(1);

                return (
                  <tr class="hover:bg-surface-secondary/50 transition-colors">
                    <td class="px-6 py-4">
                      <div class="flex items-center gap-3">
                        <span class="flex-shrink-0 w-6 h-6 bg-accent/10 text-accent rounded-full flex items-center justify-center text-sm font-semibold">
                          {index + 1}
                        </span>
                        <span class="font-semibold text-text-primary">{community?.name || ccaa.id}</span>
                      </div>
                    </td>
                    <td class="px-6 py-4 text-center">
                      <span class="font-mono font-semibold text-text-primary">{formatCurrency(ccaa.salary)}</span>
                      <span class="text-text-tertiary text-sm">/mes</span>
                      {parseFloat(vsAvg) !== 0 && (
                        <div class={`text-xs ${parseFloat(vsAvg) > 0 ? 'text-green-600' : 'text-red-600'}`}>
                          {parseFloat(vsAvg) > 0 ? '+' : ''}{vsAvg}% vs media
                        </div>
                      )}
                    </td>
                    <td class="px-6 py-4 hidden md:table-cell">
                      <span class="text-sm text-text-secondary">{ccaa.notes}</span>
                    </td>
                    <td class="px-6 py-4 text-center">
                      <a
                        href={`/${ccaaSlug}`}
                        class="inline-flex items-center justify-center px-3 py-1 text-sm bg-accent/10 text-accent rounded-lg hover:bg-accent/20 transition-colors"
                      >
                        Calcular
                      </a>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Deductions Section -->
    {profession.deductions.length > 0 && (
      <section class="py-12 bg-surface border-t border-border">
        <div class="container mx-auto px-4 max-w-5xl">
          <h2 class="font-display text-2xl font-semibold text-text-primary mb-6">
            Deducciones fiscales para {profession.name}
          </h2>

          <div class="bg-green-50 dark:bg-green-950/30 border border-green-200 dark:border-green-800 rounded-xl p-6">
            <p class="text-green-800 dark:text-green-200 mb-4">
              Como {profession.name.toLowerCase()}, puedes deducirte los siguientes gastos en tu declaración de la renta:
            </p>
            <ul class="space-y-3">
              {profession.deductions.map((deduction) => (
                <li class="flex items-start gap-3">
                  <svg class="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  <span class="text-green-800 dark:text-green-200">{deduction}</span>
                </li>
              ))}
            </ul>
          </div>

          {profession.notes && (
            <div class="mt-6 p-4 bg-blue-50 dark:bg-blue-950/30 border border-blue-200 dark:border-blue-800 rounded-lg">
              <p class="text-sm text-blue-800 dark:text-blue-200">
                <strong>Nota:</strong> {profession.notes}
              </p>
            </div>
          )}
        </div>
      </section>
    )}

    <!-- Calculator Section -->
    <section class="border-t border-border">
      <div class="container mx-auto px-4 py-8 max-w-5xl">
        <h2 class="font-display text-2xl font-semibold text-text-primary mb-4">
          Calcula tu salario neto como {profession.name}
        </h2>
        <p class="text-text-secondary mb-6">
          Introduce tu salario bruto mensual ({formatCurrency(profession.avgMonthly)} de media para {profession.name.toLowerCase()}) y tu comunidad autónoma para ver el desglose completo de impuestos.
        </p>
      </div>
      <FiscalCalculator client:only="vue" />
    </section>

    <!-- Related Professions -->
    {relatedProfessions.length > 0 && (
      <section class="py-12 bg-surface-secondary border-t border-border">
        <div class="container mx-auto px-4 max-w-5xl">
          <h2 class="font-display text-2xl font-semibold text-text-primary mb-6">
            Profesiones relacionadas
          </h2>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            {relatedProfessions.map((related) => (
              <a
                href={`/profesion/${related.slug}`}
                class="block bg-surface border border-border rounded-lg p-6 hover:border-accent transition-colors group"
              >
                <h3 class="font-semibold text-text-primary group-hover:text-accent transition-colors mb-2">
                  {related.name}
                </h3>
                <div class="text-sm text-text-secondary mb-2">
                  Salario medio: {formatCurrency(related.avgMonthly)}/mes
                </div>
                <div class="flex items-center gap-2">
                  <span class={`text-xs px-2 py-0.5 rounded ${demandLabels[related.demand]?.color}`}>
                    Demanda {demandLabels[related.demand]?.text?.toLowerCase()}
                  </span>
                </div>
              </a>
            ))}
          </div>
        </div>
      </section>
    )}

    <Footer />
    <CookieBanner />
  </div>
</BaseLayout>
